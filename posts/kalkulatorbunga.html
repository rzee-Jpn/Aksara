<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalkulator Cicilan Bunga</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root {
  --bg: #f5f5f5;
  --card: #ffffff;
  --text: #222;
  --primary: #0077ff;
}
.dark {
  --bg: #121212;
  --card: #1f1f1f;
  --text: #eaeaea;
  --primary: #4ea2ff;
}
body {
  margin:0;
  padding:20px;
  background: var(--bg);
  color: var(--text);
  font-family: Poppins, Arial;
}
.container {
  max-width: 900px;
  margin:auto;
  background: var(--card);
  padding:25px;
  border-radius:14px;
  box-shadow:0 2px 20px rgba(0,0,0,0.1);
}
input, select {
  width:100%;
  padding:10px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
  background: var(--card);
  color: var(--text);
}
button {
  width:100%;
  padding:12px;
  background: var(--primary);
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
  margin-bottom:10px;
}
.toggle {
  background:none;
  border:none;
  color: var(--text);
  font-size:18px;
  cursor:pointer;
  margin-bottom:15px;
}
.result-table-wrapper {
  width:100%;
  overflow-x:auto;
  margin-top:15px;
}
table {
  border-collapse:collapse;
  min-width:600px;
  width:100%;
  font-size:14px;
}
th, td {
  padding:6px;
  text-align:center;
  border-bottom:1px solid #ddd;
  white-space: nowrap;
}
th {
  background: var(--primary);
  color:white;
}
.result-card {
  background: var(--card);
  border-radius:8px;
  padding:15px;
  border:1px solid #3331;
  margin-top:20px;
}
canvas {
  max-width:100%;
  margin-top:20px;
}
@media(max-width:600px){
  .container{padding:15px;}
  table{font-size:12px;}
}
</style>
</head>
<body>

<div class="container">

  <button onclick="toggleMode()" class="toggle">üåô / ‚òÄÔ∏è</button>

  <h2>Kalkulator Cicilan By Anglumea</h2>

  <label>Nama User</label>
  <input type="text" id="namaUser" placeholder="Nama Anda">

  <label>Harga Barang</label>
  <input type="text" id="harga" oninput="formatRp(this)" placeholder="150.000.000">

  <label>DP</label>
  <input type="text" id="dp" oninput="formatRp(this)" placeholder="20.000.000">

  <label>Suku Bunga</label>
  <input type="number" id="bunga" placeholder="10">

  <label>Jenis Bunga</label>
  <select id="bungaTipe">
    <option value="efektif">Efektif (Anuitas)</option>
    <option value="flat">Flat</option>
  </select>

  <label>Rentang Bunga</label>
  <select id="tipeBunga">
    <option value="tahun">Per Tahun</option>
    <option value="bulan">Per Bulan</option>
  </select>

  <label>Tenor (bulan)</label>
  <select id="tenor">
    <option value="12">1 Tahun</option>
    <option value="24">2 Tahun</option>
    <option value="36">3 Tahun</option>
    <option value="60">5 Tahun</option>
    <option value="84">7 Tahun</option>
    <option value="120">10 Tahun</option>
    <option value="180">15 Tahun</option>
    <option value="240">20 Tahun</option>
  </select>

  <label>Biaya Admin</label>
  <input type="text" id="admin" oninput="formatRp(this)" placeholder="1.000.000">

  <label>Provisi (%)</label>
  <input type="number" id="provisi" placeholder="1">

  <label>Asuransi</label>
  <input type="text" id="asuransi" oninput="formatRp(this)" placeholder="2.000.000">

  <button type="button" onclick="toggleDTI()" style="background:none; border:none; color:var(--primary); cursor:pointer; margin-bottom:10px;">
    ‚ö†Ô∏è Opsional: Cek DTI Ratio
  </button>
  <div id="dtiSection" style="display:none; margin-bottom:12px;">
    <label>Gaji Bulanan</label>
    <input type="text" id="gaji" oninput="formatRp(this)" placeholder="Contoh: 10.000.000">
  </div>

  <button id="hitungBtn" onclick="hitung()">Hitung Cicilan</button>
  <button id="downloadBtn" onclick="downloadPDF()" style="display:none;">üìÑ Download PDF</button>

  <div id="summary" class="result-card" style="display:none;"></div>
  <div id="detail"></div>

  <canvas id="grafikCicilan"></canvas>

</div>

<script>
function toggleMode(){document.body.classList.toggle("dark");}
function toggleDTI(){const sec=document.getElementById("dtiSection");sec.style.display=sec.style.display==="none"?"block":"none";}
function formatRp(input){let v=input.value.replace(/\D/g,"");input.value=new Intl.NumberFormat("id-ID").format(v);}
function toNumber(str){return parseFloat(str.replace(/\./g,""))||0;}
function format(v){return new Intl.NumberFormat("id-ID").format(v.toFixed(0));}

let chart;

function hitung(){
  const namaUser=document.getElementById("namaUser").value||"User";
  const harga=toNumber(document.getElementById("harga").value);
  const dp=toNumber(document.getElementById("dp").value);
  const bunga=parseFloat(document.getElementById("bunga").value)/100;
  const tipeBunga=document.getElementById("tipeBunga").value;
  const bungaTipe=document.getElementById("bungaTipe").value;
  const tenor=parseInt(document.getElementById("tenor").value);

  const admin=toNumber(document.getElementById("admin").value);
  const provisiPersen=parseFloat(document.getElementById("provisi").value)/100;
  const asuransi=toNumber(document.getElementById("asuransi").value);

  const pinjaman=harga-dp;
  let provisi=pinjaman*provisiPersen;
  let bungaBulanan=tipeBunga==="tahun"?bunga/12:bunga;

  const results={efektif:[], flat:[]};

  function hitungType(type){
    let sisa=pinjaman;
    const arr=[];
    let cicilanBulanan=0;
    if(type==="efektif"){
      cicilanBulanan=(pinjaman*bungaBulanan)/(1-Math.pow(1+bungaBulanan,-tenor));
    }
    for(let i=1;i<=tenor;i++){
      let bungaPerBulan,pokok;
      if(type==="efektif"){
        bungaPerBulan=sisa*bungaBulanan;
        pokok=cicilanBulanan-bungaPerBulan;
        sisa-=pokok;
      } else {
        pokok=pinjaman/tenor;
        bungaPerBulan=pinjaman*bungaBulanan;
        sisa-=pokok;
        cicilanBulanan=pokok+bungaPerBulan;
      }
      const cumulative=(arr.length>0?arr[arr.length-1].total:0)+pokok+bungaPerBulan;
      arr.push({bulan:i,cicilan:cicilanBulanan,pokok:pokok,bunga:bungaPerBulan,total:cumulative});
    }
    return arr;
  }

  results.efektif=hitungType("efektif");
  results.flat=hitungType("flat");

  // Table
  let table='<div class="result-table-wrapper"><table><tr><th>Bulan</th><th>Cicilan</th><th>Pokok</th><th>Bunga</th><th>Sisa</th></tr>';
  let sisaPinjaman=pinjaman;
  const selectedResults=results[bungaTipe];
  selectedResults.forEach(r=>{
    table+=`<tr>
      <td>${r.bulan}</td>
      <td>Rp ${format(r.cicilan)}</td>
      <td>Rp ${format(r.pokok)}</td>
      <td>Rp ${format(r.bunga)}</td>
      <td>Rp ${format(Math.max(sisaPinjaman-=r.pokok,0))}</td>
    </tr>`;
  });
  table+='</table></div>';

  const totalBiayaAwal=dp+admin+provisi+asuransi;
  const totalPembayaran=selectedResults[selectedResults.length-1].total+admin+provisi+asuransi+dp;

  // DTI
  const gaji=toNumber(document.getElementById("gaji")?.value||"0");
  let dtiWarning="";
  if(gaji>0){
    const dti=(selectedResults[0].cicilan/gaji)*100;
    dtiWarning=dti>30
      ? `<p style="color:red;"><b>‚ö†Ô∏è Peringatan:</b> Cicilan per bulan ${dti.toFixed(1)}% dari gaji Anda, melebihi 30%</p>`
      : `<p style="color:green;">DTI Ratio: ${dti.toFixed(1)}%</p>`;
  }

  document.getElementById("summary").style.display="block";
  document.getElementById("summary").innerHTML=`
    <h3>Ringkasan</h3>
    <p><b>Nama:</b> ${namaUser}</p>
    <p><b>Pinjaman:</b> Rp ${format(pinjaman)}</p>
    <p><b>Cicilan / bulan:</b> Rp ${format(selectedResults[0].cicilan)}</p>
    <p><b>Total Biaya Awal (DP + biaya):</b> Rp ${format(totalBiayaAwal)}</p>
    <p><b>Total Pembayaran Keseluruhan:</b> Rp ${format(totalPembayaran)}</p>
    ${dtiWarning}
  `;
  document.getElementById("detail").innerHTML=`<h3>Rincian Per Bulan</h3>${table}`;

  // Chart
  const ctx=document.getElementById('grafikCicilan').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:results.efektif.map(r=>r.bulan),
      datasets:[
        {label:'Efektif',data:results.efektif.map(r=>r.total),borderColor:'blue',backgroundColor:'rgba(0,0,255,0.2)',fill:true},
        {label:'Flat',data:results.flat.map(r=>r.total),borderColor:'orange',backgroundColor:'rgba(255,165,0,0.2)',fill:true}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:'top'},title:{display:true,text:'Grafik Cumulative Pokok + Bunga'}},
      interaction:{mode:'index',intersect:false},
      scales:{x:{title:{display:true,text:'Bulan'}},y:{title:{display:true,text:'Akumulasi (Rp)'}}}
    }
  });

  // Tampilkan tombol download PDF setelah hasil dihitung
  document.getElementById("downloadBtn").style.display="block";
}

// Download PDF multi-halaman
function downloadPDF(){
  const namaUser=document.getElementById('namaUser').value||'User';
  const now=new Date();

  // Wrapper PDF
  const pdfWrapper=document.createElement('div');

  // Halaman 1 (portrait)
  const header1=document.createElement('div');
  header1.innerHTML=`<h2 style="text-align:center;">Kalkulator Cicilan</h2>
  <p>Nama User: ${namaUser}</p>
  <p>Tanggal Cetak: ${now.toLocaleString()}</p>
  <hr>`;
  pdfWrapper.appendChild(header1);

  // Clone container untuk summary + tabel
  const containerClone=document.querySelector('.container').cloneNode(true);
  // Hapus tombol dan canvas agar bersih
  containerClone.querySelector('#hitungBtn')?.remove();
  containerClone.querySelector('#downloadBtn')?.remove();
  containerClone.querySelector('.toggle')?.remove();
  const canvas=document.createElement('canvas'); // kosongkan canvas
  containerClone.querySelector('#grafikCicilan')?.replaceWith(canvas);
  pdfWrapper.appendChild(containerClone);

  // Halaman 2 (landscape) untuk grafik
  const chartWrapper=document.createElement('div');
  chartWrapper.style.width='100%';
  chartWrapper.style.height='400px';
  chartWrapper.innerHTML='<h3 style="text-align:center;">Grafik Cumulative Pokok + Bunga</h3>';
  const chartClone=document.createElement('canvas');
  chartClone.width=1200;
  chartClone.height=600;
  chartWrapper.appendChild(chartClone);
  pdfWrapper.appendChild(chartWrapper);

  // Copy data chart asli ke chart clone
  const origData=chart.data;
  const origOptions=chart.options;
  new Chart(chartClone.getContext('2d'),{
    type:'line',
    data:origData,
    options:Object.assign({}, origOptions, {responsive:false})
  });

  // Generate PDF multi-halaman
  html2pdf().from(pdfWrapper).set({
    margin:[10,10,10,10],
    filename:'Kalkulator_Cicilan_Full.pdf',
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
    pagebreak:{mode:['css','legacy']}
  }).save();
}
</script>

</body>
</html>
